---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import VideoCard from '../../../components/VideoCard.astro';

export async function getStaticPaths() {
  const allVideos = await getCollection('videos');
  const sortedVideos = allVideos.sort(
    (a, b) =>
      new Date(b.data.publishedAt).getTime() -
      new Date(a.data.publishedAt).getTime()
  );

  const pageSize = 9;
  const totalPages = Math.ceil(sortedVideos.length / pageSize);

  function buildPageWindow(current, total, windowSize = 10) {
    const pages = [];
    const half = Math.floor(windowSize / 2);
    let start = Math.max(1, current - half);
    let end = Math.min(total, start + windowSize - 1);
    if (end - start + 1 < windowSize) {
      start = Math.max(1, end - windowSize + 1);
    }
    for (let p = start; p <= end; p++) {
      pages.push(p);
    }
    return pages;
  }

  const paths = Array.from({ length: totalPages }, (_, i) => {
    const page = i + 1;
    const start = i * pageSize;
    const end = start + pageSize;
    const pageVideos = sortedVideos.slice(start, end);

    return {
      params: { page: String(page) },
      props: { page, totalPages, videos: pageVideos, pageWindow: buildPageWindow(page, totalPages, 10) },
    };
  });

  return paths;
}

const { page, totalPages, videos, pageWindow } = Astro.props;
---

<BaseLayout title={`Videos - Page ${page}`} description="Browse all videos">
  <div class="videos-page">
    <div class="videos-header">
      <h1>All Videos</h1>
      <p>
        Page {page} of {totalPages}
      </p>
    </div>

    <div class="videos-grid">
      {videos.map((video) => (
        <VideoCard video={video} />
      ))}
    </div>

    {videos.length === 0 && (
      <div class="empty-state">
        <p>No videos found. Check back soon!</p>
      </div>
    )}

    <nav class="pagination" aria-label="Pagination">
      {page > 1 && (
        <a
          class="page-link prev"
          href={page - 1 === 1 ? '/videos' : `/videos/page/${page - 1}`}
          rel="prev"
        >
          Previous
        </a>
      )}

      <div class="page-numbers">
        {pageWindow[0] > 1 && (
          <a class="page-link" href="/videos">1</a>
        )}
        {pageWindow[0] > 2 && <span class="ellipsis">…</span>}

        {pageWindow.map((p) => {
          const href = p === 1 ? '/videos' : `/videos/page/${p}`;
          return (
            <a class={`page-link ${p === page ? 'active' : ''}`} href={href}>
              {p}
            </a>
          );
        })}

        {pageWindow[pageWindow.length - 1] < totalPages - 1 && <span class="ellipsis">…</span>}
        {pageWindow[pageWindow.length - 1] < totalPages && (
          <a class="page-link" href={`/videos/page/${totalPages}`}>{totalPages}</a>
        )}
      </div>

      {page < totalPages && (
        <a class="page-link next" href={`/videos/page/${page + 1}`} rel="next">
          Next
        </a>
      )}
    </nav>
  </div>
</BaseLayout>

<style>
  .videos-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .videos-header {
    margin-bottom: 2rem;
    text-align: center;
  }

  .videos-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    color: #e6efff;
  }

  .videos-header p {
    font-size: 1.125rem;
    color: #9fb6d5;
  }

  .videos-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
  }

  .page-numbers {
    display: flex;
    gap: 0.5rem;
  }

  .page-link {
    display: inline-block;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    text-decoration: none;
    border: 1px solid #4a5f7f;
    color: #b0c4de;
    transition: all 0.2s ease;
    background: transparent;
  }

  .page-link:hover {
    border-color: #7dd3fc;
    color: #e6efff;
  }

  .page-link.active {
    background: #eef2ff;
    border-color: #c7d2fe;
    color: #3730a3;
    font-weight: 600;
  }

  .ellipsis {
    color: #9ca3af;
    padding: 0 0.25rem;
  }

  @media (max-width: 768px) {
    .videos-page {
      padding: 1rem;
    }

    .videos-header h1 {
      font-size: 2rem;
    }

    .videos-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }
</style>
