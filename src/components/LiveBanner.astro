---
// LiveBanner component - checks YouTube live status via Cloudflare Worker
// Displays a prominent banner when the channel is streaming live

// The worker URL - keeps API key secure on the server
const liveStatusUrl = import.meta.env.PUBLIC_LIVE_STATUS_URL || '';
---

<div 
  id="live-banner" 
  class="live-banner hidden"
  data-live-status-url={liveStatusUrl}
>
  <a id="live-banner-link" href="#" target="_blank" rel="noopener noreferrer" class="live-banner-content">
    <span class="live-indicator">
      <span class="live-dot"></span>
      LIVE
    </span>
    <span id="live-title" class="live-title">Streaming now on YouTube!</span>
    <span class="live-cta">Watch Now â†’</span>
  </a>
  <button id="live-banner-close" class="live-banner-close" aria-label="Close banner">Ã—</button>
</div>

<script>
  interface LiveStreamData {
    isLive: boolean;
    videoId?: string;
    title?: string;
  }

  class LiveBannerController {
    private banner: HTMLElement | null;
    private link: HTMLAnchorElement | null;
    private titleEl: HTMLElement | null;
    private closeBtn: HTMLElement | null;
    private liveStatusUrl: string;
    private checkInterval: number = 60000; // Check every 60 seconds
    private intervalId: number | null = null;

    constructor() {
      this.banner = document.getElementById('live-banner');
      this.link = document.getElementById('live-banner-link') as HTMLAnchorElement;
      this.titleEl = document.getElementById('live-title');
      this.closeBtn = document.getElementById('live-banner-close');
      this.liveStatusUrl = this.banner?.dataset.liveStatusUrl || '';

      this.init();
    }

    private init(): void {
      // Test mode: add ?testlive=true to URL to preview the banner (localhost only)
      const urlParams = new URLSearchParams(window.location.search);
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const testMode = isLocalhost && urlParams.get('testlive') === 'true';

      if (testMode) {
        console.log('Live banner: Test mode enabled (localhost only)');
        this.showBanner('test123', 'ðŸ”´ TEST MODE - This is how the live banner looks!');
        return;
      }

      if (!this.liveStatusUrl) {
        console.log('Live banner: Missing live status URL, skipping live check');
        return;
      }

      // Check if user dismissed the banner this session
      if (sessionStorage.getItem('liveBannerDismissed')) {
        return;
      }

      // Set up close button
      this.closeBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        this.hideBanner();
        sessionStorage.setItem('liveBannerDismissed', 'true');
      });

      // Initial check
      this.checkLiveStatus();

      // Set up periodic checks
      this.intervalId = window.setInterval(() => {
        this.checkLiveStatus();
      }, this.checkInterval);
    }

    private async checkLiveStatus(): Promise<void> {
      try {
        const data = await this.fetchLiveStatus();
        
        if (data.isLive && data.videoId) {
          this.showBanner(data.videoId, data.title || 'Live now!');
        } else {
          this.hideBanner();
        }
      } catch (error) {
        console.error('Live banner: Error checking live status', error);
      }
    }

    private async fetchLiveStatus(): Promise<LiveStreamData> {
      // Call the Cloudflare Worker proxy instead of YouTube directly
      const response = await fetch(this.liveStatusUrl);
      
      if (!response.ok) {
        throw new Error(`Live status API error: ${response.status}`);
      }

      return await response.json();
    }

    private showBanner(videoId: string, title: string): void {
      if (!this.banner || !this.link || !this.titleEl) return;

      // Don't show if user dismissed
      if (sessionStorage.getItem('liveBannerDismissed')) return;

      this.link.href = `https://www.youtube.com/watch?v=${videoId}`;
      this.titleEl.textContent = title;
      this.banner.classList.remove('hidden');
      this.banner.classList.add('visible');

      // Also add indicator to nav
      this.updateNavIndicator(true);
    }

    private hideBanner(): void {
      if (!this.banner) return;
      
      this.banner.classList.add('hidden');
      this.banner.classList.remove('visible');
      this.updateNavIndicator(false);
    }

    private updateNavIndicator(isLive: boolean): void {
      const logo = document.querySelector('.navbar-logo');
      if (!logo) return;

      let indicator = document.getElementById('nav-live-indicator');
      
      if (isLive && !indicator) {
        indicator = document.createElement('span');
        indicator.id = 'nav-live-indicator';
        indicator.className = 'nav-live-indicator';
        indicator.innerHTML = '<span class="live-dot-small"></span>LIVE';
        logo.parentElement?.insertBefore(indicator, logo.nextSibling);
      } else if (!isLive && indicator) {
        indicator.remove();
      }
    }

    public destroy(): void {
      if (this.intervalId) {
        clearInterval(this.intervalId);
      }
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    new LiveBannerController();
  });

  // Also initialize immediately if DOM is already loaded
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    new LiveBannerController();
  }
</script>

<style>
  .live-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: linear-gradient(90deg, #dc2626, #b91c1c);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    transform: translateY(-100%);
    transition: transform 0.3s ease-in-out;
    box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
  }

  .live-banner.visible {
    transform: translateY(0);
  }

  .live-banner.hidden {
    transform: translateY(-100%);
  }

  .live-banner-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: white;
    text-decoration: none;
    font-weight: 600;
    flex: 1;
    justify-content: center;
  }

  .live-banner-content:hover {
    text-decoration: none;
  }

  .live-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-weight: 700;
    font-size: 0.875rem;
    letter-spacing: 0.05em;
  }

  .live-dot {
    width: 10px;
    height: 10px;
    background: white;
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.5;
      transform: scale(1.2);
    }
  }

  .live-title {
    max-width: 400px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.95rem;
  }

  .live-cta {
    background: rgba(255, 255, 255, 0.25);
    padding: 0.375rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: background 0.2s ease;
  }

  .live-banner-content:hover .live-cta {
    background: rgba(255, 255, 255, 0.35);
  }

  .live-banner-close {
    background: transparent;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    opacity: 0.7;
    transition: opacity 0.2s ease;
    line-height: 1;
  }

  .live-banner-close:hover {
    opacity: 1;
  }

  /* Navigation live indicator */
  :global(.nav-live-indicator) {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    background: #dc2626;
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 700;
    margin-left: 0.75rem;
    letter-spacing: 0.05em;
    animation: glow 2s ease-in-out infinite;
  }

  :global(.live-dot-small) {
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes glow {
    0%, 100% {
      box-shadow: 0 0 5px rgba(220, 38, 38, 0.5);
    }
    50% {
      box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
    }
  }

  @media (max-width: 768px) {
    .live-banner {
      padding: 0.5rem 0.75rem;
    }

    .live-banner-content {
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .live-title {
      max-width: 200px;
      font-size: 0.85rem;
    }

    .live-cta {
      display: none;
    }

    .live-indicator {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
    }
  }
</style>
